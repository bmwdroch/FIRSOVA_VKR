# 3.6. Разработка и внедрение веб-приложения

После разработки и оптимизации модели прогнозирования оттока клиентов было создано веб-приложение, обеспечивающее удобный интерфейс для ввода данных о клиентах и получения прогнозов вероятности их оттока. В данном разделе описывается процесс проектирования, разработки и реализации этого приложения.

## 3.6.1. Архитектура веб-приложения

### Общая структура приложения

Для разработки веб-приложения был выбран микрофреймворк Flask из-за его простоты, гибкости и широких возможностей интеграции с инструментами машинного обучения и аналитики данных. Общая архитектура приложения представлена ниже.

```
Архитектура веб-приложения:
+-------------------+       +--------------------+
|                   |       |                    |
|  Веб-интерфейс    | ----> |  Flask-приложение  |
|  (HTML/CSS/JS)    | <---- |                    |
|                   |       |                    |
+-------------------+       +---------+----------+
                                      |
                                      |
                            +---------v----------+
                            |                    |
                            |  Модель XGBoost    |
                            |  + Препроцессор    |
                            |                    |
                            +--------------------+
```

Приложение реализовано по принципу модульной архитектуры, включающей следующие основные компоненты:

```
telco_churn_prediction/
├── app/                       # Директория приложения
│   ├── templates/             # HTML-шаблоны
│   │   ├── base.html          # Базовый шаблон
│   │   ├── index.html         # Главная страница с формой ввода
│   │   ├── result.html        # Страница с результатами прогноза
│   │   └── error.html         # Страница с ошибками
│   ├── utils/                 # Вспомогательные модули
│   │   ├── __init__.py        # Инициализация пакета
│   │   └── model_utils.py     # Модуль для работы с моделью
│   ├── __init__.py            # Инициализация пакета app
│   └── app.py                 # Основной файл Flask-приложения
├── models/                    # Директория с моделями
│   ├── best_model.joblib      # Лучшая модель (XGBoost)
│   └── preprocessor.joblib    # Препроцессор для данных
```

### Компоненты приложения

#### 1. Основной файл приложения (app.py)

Файл `app.py` содержит основную логику Flask-приложения и включает следующие функциональные возможности:

- **Маршруты (routes)**:
  - `/` - Главная страница с формой ввода данных клиента
  - `/predict` - Обработка данных формы и отображение результатов прогноза
  - `/api/predict` - API-эндпоинт для получения прогноза в формате JSON

- **Функциональность**:
  - Загрузка модели и препроцессора при запуске приложения
  - Рендеринг HTML-шаблонов для веб-интерфейса
  - Обработка данных, полученных из формы
  - Получение прогноза от модели
  - Отображение результатов пользователю

```python
@app.route('/predict', methods=['POST'])
def predict():
    """Обработка данных формы и выдача прогноза"""
    try:
        # Получение данных из формы
        form_data = request.form.to_dict()
        
        # Получение прогноза от модели
        prediction, probability = predict_churn(model, preprocessor, form_data)
        
        # Определение результата в текстовом виде
        result_text = "Вероятен уход" if prediction == 1 else "Вероятно останется"
        
        # Преобразование вероятности в проценты
        probability_percent = round(probability * 100, 2)
        
        return render_template(
            'result.html', 
            prediction=prediction,
            result_text=result_text,
            probability=probability,
            probability_percent=probability_percent,
            client_data=form_data
        )
    except Exception as e:
        return render_template('error.html', error=str(e))
```

#### 2. Модуль для работы с моделью (model_utils.py)

Модуль `model_utils.py` содержит логику взаимодействия с моделью машинного обучения и включает следующие основные функции:

- `load_model_and_preprocessor()` - Загрузка модели и препроцессора из файлов
- `prepare_data()` - Преобразование данных клиента в формат, подходящий для модели
- `predict_churn()` - Получение прогноза оттока клиента

```python
def predict_churn(model, preprocessor, client_data):
    """
    Получение прогноза оттока для данных клиента
    
    Аргументы:
        model: Обученная модель
        preprocessor: Препроцессор для данных
        client_data: Словарь с данными клиента
        
    Возвращает:
        tuple: (prediction, probability), где
            prediction - бинарный прогноз (0/1)
            probability - вероятность оттока
    """
    # Подготовка данных
    X = prepare_data(client_data, preprocessor)
    
    # Получение прогноза и вероятности
    prediction = model.predict(X)[0]
    probability = model.predict_proba(X)[0, 1]  # Вероятность класса 1 (отток)
    
    return prediction, probability
```

#### 3. HTML-шаблоны

Веб-приложение использует следующие HTML-шаблоны для отображения пользовательского интерфейса:

- **base.html** - Базовый шаблон с общей структурой всех страниц, включая подключение Bootstrap 5 для стилизации
- **index.html** - Форма для ввода данных клиента
- **result.html** - Отображение результатов прогноза
- **error.html** - Отображение информации об ошибках

## 3.6.2. Интеграция с моделью машинного обучения

Интеграция веб-приложения с моделью машинного обучения XGBoost является ключевым аспектом системы и реализована следующим образом:

### Загрузка модели и препроцессора

Модель и препроцессор загружаются однократно при запуске приложения, что позволяет избежать излишних вычислительных затрат при обработке запросов:

```python
def load_model_and_preprocessor():
    """
    Загрузка модели и препроцессора из файлов
    
    Возвращает:
        tuple: (model, preprocessor)
    """
    try:
        # Определение путей к файлам моделей
        base_dir = Path(__file__).resolve().parents[2]
        model_path = base_dir / "models" / "best_model.joblib"
        preprocessor_path = base_dir / "models" / "preprocessor.joblib"
        
        # Загрузка модели и препроцессора
        model = joblib.load(model_path)
        preprocessor = joblib.load(preprocessor_path)
        
        return model, preprocessor
    except Exception as e:
        raise RuntimeError(f"Ошибка при загрузке модели или препроцессора: {str(e)}")
```

### Преобразование данных

Для корректной работы модели необходимо преобразовать пользовательский ввод в формат, соответствующий формату данных, использованному при обучении модели:

```python
def prepare_data(client_data, preprocessor):
    """
    Преобразование данных клиента в формат для модели
    
    Аргументы:
        client_data: Словарь с данными клиента
        preprocessor: Препроцессор для данных
        
    Возвращает:
        numpy.ndarray: Подготовленные данные для модели
    """
    # Создание копии данных
    data = client_data.copy()
    
    # Преобразование SeniorCitizen из Yes/No в 1/0
    if 'SeniorCitizen' in data:
        data['SeniorCitizen'] = 1 if data['SeniorCitizen'] == 'Yes' else 0
    
    # Преобразование строковых числовых значений в числа
    for key in ['tenure', 'MonthlyCharges', 'TotalCharges']:
        if key in data and data[key]:
            data[key] = float(data[key])
    
    # Преобразование в DataFrame
    df = pd.DataFrame([data])
    
    # Применение препроцессора
    X_transformed = preprocessor.transform(df)
    
    return X_transformed
```

### Получение прогноза

Получение прогноза осуществляется путем применения модели к преобразованным данным:

```python
# Получение прогноза и вероятности
prediction = model.predict(X)[0]
probability = model.predict_proba(X)[0, 1]  # Вероятность класса 1 (отток)
```

## 3.6.3. Пользовательский интерфейс

Пользовательский интерфейс веб-приложения разработан с учетом простоты использования и наглядности представления информации. Основные элементы интерфейса включают:

### Форма ввода данных

Форма ввода данных о клиенте содержит все необходимые поля, сгруппированные по категориям для удобства заполнения:

1. **Демографические данные**:
   - Пол клиента (gender)
   - Является ли клиент пожилым (SeniorCitizen)
   - Наличие партнера (Partner)
   - Наличие иждивенцев (Dependents)

2. **Данные об услугах**:
   - Срок обслуживания в месяцах (tenure)
   - Телефонная услуга (PhoneService)
   - Несколько телефонных линий (MultipleLines)
   - Тип интернет-услуги (InternetService)
   - Услуги безопасности и поддержки (OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport)
   - Стриминговые услуги (StreamingTV, StreamingMovies)

3. **Данные о контракте**:
   - Тип контракта (Contract)
   - Безбумажный расчет (PaperlessBilling)
   - Способ оплаты (PaymentMethod)
   - Ежемесячная плата (MonthlyCharges)
   - Общая сумма платежей (TotalCharges)

```
+-------------------------------------------------+
|               Форма ввода данных                |
+-------------------------------------------------+
| Демографические данные                          |
|  Пол: ○ Male  ○ Female                          |
|  Пожилой клиент: ○ Да  ○ Нет                   |
|  Партнер: ○ Да  ○ Нет                          |
|  Иждивенцы: ○ Да  ○ Нет                        |
|                                                 |
| Услуги                                          |
|  Срок обслуживания: [    ] месяцев              |
|  Телефонная услуга: ○ Да  ○ Нет                |
|  Множественные линии: [Выпадающий список]       |
|  Интернет-сервис: [Выпадающий список]           |
|  ...                                            |
|                                                 |
| Контракт                                        |
|  Тип контракта: [Выпадающий список]             |
|  Безбумажный расчет: ○ Да  ○ Нет               |
|  Способ оплаты: [Выпадающий список]             |
|  Ежемесячная плата: [    ] $                    |
|  Общая сумма платежей: [    ] $                 |
|                                                 |
|            [   Предсказать отток   ]            |
+-------------------------------------------------+
```

### Отображение результатов

Страница с результатами прогноза содержит:

1. **Бинарный прогноз** - "Вероятен уход" или "Вероятно останется"
2. **Вероятность оттока** - числовое значение в процентах
3. **Визуальное представление** - цветовое кодирование результата (красный для высокого риска оттока, зеленый для низкого)
4. **Сводка введенных данных** - таблица с данными клиента, для которого был сделан прогноз

```
+-------------------------------------------------+
|             Результат прогнозирования           |
+-------------------------------------------------+
|                                                 |
|  Прогноз: Вероятен уход                         |
|                                                 |
|  Вероятность оттока: 78.3%                      |
|                                                 |
|  +-------------------------------------------+  |
|  |                                           |  |
|  |  ███████████████████████████░░░░░░░░░     |  |
|  |  78.3%                                    |  |
|  |                                           |  |
|  +-------------------------------------------+  |
|                                                 |
|  Данные клиента:                                |
|    Gender: Male                                 |
|    SeniorCitizen: No                            |
|    Partner: No                                  |
|    ...                                          |
|                                                 |
|             [   Вернуться к форме   ]           |
+-------------------------------------------------+
```

## 3.6.4. API для интеграции с другими системами

Для обеспечения возможности интеграции с другими системами веб-приложение предоставляет REST API, позволяющий получать прогнозы в формате JSON:

```python
@app.route('/api/predict', methods=['POST'])
def api_predict():
    """API-эндпоинт для получения прогноза в формате JSON"""
    try:
        # Получение данных из JSON-запроса
        client_data = request.json
        
        # Проверка наличия данных
        if not client_data:
            return jsonify({
                'status': 'error', 
                'message': 'Отсутствуют данные клиента'
            }), 400
        
        # Получение прогноза от модели
        prediction, probability = predict_churn(model, preprocessor, client_data)
        
        # Формирование ответа
        response = {
            'status': 'success',
            'prediction': int(prediction),
            'prediction_text': "Вероятен уход" if prediction == 1 else "Вероятно останется",
            'probability': float(probability),
            'probability_percent': round(float(probability) * 100, 2)
        }
        
        return jsonify(response)
    except Exception as e:
        return jsonify({
            'status': 'error', 
            'message': str(e)
        }), 500
```

API-эндпоинт `/api/predict` принимает POST-запросы с данными клиента в формате JSON и возвращает результат прогноза, который включает:

- Статус запроса (success/error)
- Бинарный прогноз (0/1)
- Текстовое представление прогноза
- Вероятность оттока (от 0 до 1)
- Вероятность оттока в процентах

Данный API может использоваться для автоматизации процесса прогнозирования оттока для большого количества клиентов или интеграции с CRM-системами компании.

## 3.6.5. Развертывание приложения

Для запуска и развертывания приложения были разработаны подробные инструкции, обеспечивающие корректную установку всех зависимостей и запуск приложения:

1. **Подготовка окружения**:
   - Создание и активация виртуального окружения Python
   - Установка необходимых зависимостей из requirements.txt

```bash
# Создание виртуального окружения
python -m venv venv

# Активация виртуального окружения
# Linux/Mac:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# Установка зависимостей
pip install -r requirements.txt
```

2. **Запуск приложения**:
   - Переход в директорию приложения
   - Запуск Flask-сервера

```bash
# Переход в директорию проекта
cd telco_churn_prediction

# Запуск приложения
python -m app.app
```

После запуска приложение доступно по адресу http://127.0.0.1:5000/ в веб-браузере.

## 3.6.6. Тестирование веб-приложения

Для обеспечения корректной работы веб-приложения было проведено комплексное тестирование, включающее:

1. **Функциональное тестирование**:
   - Проверка работы всех маршрутов (`/`, `/predict`, `/api/predict`)
   - Тестирование обработки данных формы
   - Проверка корректности прогнозов для различных входных данных

2. **Тестирование обработки ошибок**:
   - Обработка некорректных входных данных
   - Проверка поведения при отсутствии файлов моделей
   - Тестирование граничных случаев (пустые поля, недопустимые значения)

3. **Тестирование API**:
   - Проверка API-запросов с различными данными
   - Тестирование ответов API на некорректные запросы
   - Проверка формата JSON-ответов

В процессе тестирования были выявлены и устранены следующие проблемы:

1. Несоответствие размерностей между обученной моделью и препроцессором, что требовало адаптации данных
2. Проблемы с импортом модулей, решенные путем модификации импортов в app.py
3. Некорректное преобразование категориальных переменных, устраненное путем добавления специальной обработки в функцию prepare_data

## 3.6.7. Результаты и выводы

В результате разработки и внедрения веб-приложения для прогнозирования оттока клиентов были получены следующие результаты:

1. Создано полнофункциональное веб-приложение, предоставляющее простой и интуитивно понятный интерфейс для прогнозирования оттока клиентов на основе оптимизированной модели XGBoost.

2. Реализована эффективная интеграция с моделью машинного обучения, обеспечивающая быструю и точную обработку данных и получение прогнозов.

3. Разработан REST API для интеграции с другими системами, позволяющий автоматизировать процесс прогнозирования оттока для большого количества клиентов.

4. Проведено комплексное тестирование приложения, подтвердившее его корректную работу и надежность.

Внедрение разработанного веб-приложения в бизнес-процессы телекоммуникационной компании позволит:

- Автоматизировать процесс выявления клиентов с высоким риском оттока
- Повысить эффективность программ удержания клиентов за счет точного таргетирования
- Сократить затраты на маркетинговые кампании по удержанию клиентов
- Улучшить пользовательский опыт сотрудников, работающих с системой прогнозирования оттока

Дальнейшее развитие системы может включать:

1. Добавление дополнительной функциональности, такой как пакетное прогнозирование для нескольких клиентов одновременно
2. Интеграцию с CRM-системой компании для автоматического получения данных о клиентах
3. Разработку модуля визуализации результатов прогнозирования (графики, диаграммы)
4. Расширение возможностей API для поддержки более сложных сценариев использования 